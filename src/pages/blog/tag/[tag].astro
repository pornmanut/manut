---
import BlogLayout from '../../../layouts/BlogLayout.astro';
import { getCollection } from 'astro:content';
import PostCardEnhanced from '../../../components/PostCardEnhanced.astro';
import Header from '../../../components/Header.astro';
import TagFilter from '../../../components/TagFilter.astro';

export async function getStaticPaths() {
	const posts = await getCollection('blog', ({ data }) => {
		return data.draft !== true;
	});
	
	const allTags = [...new Set(posts.flatMap(post => post.data.tags))];
	
	return allTags.map((tag) => {
		const filteredPosts = posts.filter((post) =>
			post.data.tags.includes(tag)
		);
		
		return {
			params: { tag },
			props: { posts: filteredPosts, tag },
		};
	});
}

const { posts, tag } = Astro.props;

// Sort posts by publication date (newest first)
const sortedPosts = posts.sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);
---

<BlogLayout title={`Posts tagged with "${tag}"`}>
	<Header currentPath={`/blog/tag/${tag}`} />
	
	<div class="container mx-auto px-4 py-8 max-w-6xl">
		<div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
			<main class="lg:col-span-3">
				<section>
					<h1 class="text-3xl font-bold mb-2 text-primary font-sans">Posts tagged with "{tag}"</h1>
					<p class="text-muted-foreground mb-8 font-sans">
						Found {sortedPosts.length} post{sortedPosts.length !== 1 ? 's' : ''} tagged with "{tag}"
					</p>
					
					{sortedPosts.length > 0 ? (
						<div class="space-y-8">
							{sortedPosts.map((post) => (
								<PostCardEnhanced post={post} />
							))}
						</div>
					) : (
						<div class="text-center py-12">
							<p class="text-muted-foreground text-lg">No posts found with this tag.</p>
						</div>
					)}
					
					<div class="mt-12 pt-8 border-t">
						<a 
							href="/" 
							class="inline-flex items-center text-primary hover:underline font-medium"
						>
							‚Üê Back to all posts
						</a>
					</div>
				</section>
			</main>
			
			<aside class="lg:col-span-1">
				<TagFilter currentTag={tag} />
			</aside>
		</div>
	</div>
</BlogLayout>
