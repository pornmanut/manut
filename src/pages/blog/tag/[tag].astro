---
import BlogLayout from '../../../layouts/BlogLayout.astro';
import { getCollection } from 'astro:content';
import PostCard from '../../../components/PostCard.astro';
import Header from '../../../components/Header.astro';
import TagFilter from '../../../components/TagFilter.astro';

export async function getStaticPaths() {
	const posts = await getCollection('blog', ({ data }) => {
		return data.draft !== true;
	});
	
	const allTags = [...new Set(posts.flatMap(post => post.data.tags))];
	
	return allTags.map((tag) => {
		const filteredPosts = posts.filter((post) =>
			post.data.tags.includes(tag)
		);
		
		return {
			params: { tag },
			props: { posts: filteredPosts, tag },
		};
	});
}

const { posts, tag } = Astro.props;

// Sort posts by publication date (newest first)
const sortedPosts = posts.sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);
---

<BlogLayout title={`Posts tagged with "${tag}"`}>
	<Header currentPath={`/blog/tag/${tag}`} />
	
	<div class="content-wrapper">
		<main class="main-content">
			<section class="tagged-posts">
				<h1>Posts tagged with "{tag}"</h1>
				<p class="tag-description">
					Found {sortedPosts.length} post{sortedPosts.length !== 1 ? 's' : ''} tagged with "{tag}"
				</p>
				
				{sortedPosts.length > 0 ? (
					<div class="posts-grid">
						{sortedPosts.map((post) => (
							<PostCard post={post} />
						))}
					</div>
				) : (
					<p>No posts found with this tag.</p>
				)}
				
				<div class="back-to-all">
					<a href="/">&larr; Back to all posts</a>
				</div>
			</section>
		</main>
		
		<aside class="sidebar">
			<TagFilter currentTag={tag} />
		</aside>
	</div>
	
	<style>
		.tagged-posts h1 {
			font-family: var(--font-ui);
			font-size: 2rem;
			margin-bottom: 8px;
			color: var(--primary-color);
		}
		
		.tag-description {
			color: var(--secondary-color);
			font-family: var(--font-ui);
			margin-bottom: 32px;
		}
		
		.posts-grid {
			display: grid;
			gap: 32px;
			grid-template-columns: 1fr;
		}
		
		@media (min-width: 768px) {
			.posts-grid {
				grid-template-columns: repeat(2, 1fr);
			}
		}
		
		@media (min-width: 1024px) {
			.posts-grid {
				grid-template-columns: 1fr;
			}
		}
		
		.back-to-all {
			margin-top: 48px;
			padding-top: 24px;
			border-top: 1px solid var(--border-color);
		}
		
		.back-to-all a {
			font-family: var(--font-ui);
			font-weight: 500;
			color: var(--secondary-color);
			text-decoration: none;
		}
		
		.back-to-all a:hover {
			color: var(--accent-color);
		}
	</style>
</BlogLayout>
