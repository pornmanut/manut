---
import BaseLayout from '../../layouts/BaseLayout.astro';
---

<BaseLayout title="Money Manager - Manut.dev" description="Track your income and expenses with this simple money management tool">
  <div class="space-y-8">
    <section class="text-center py-12">
      <h1 class="text-4xl font-bold text-gray-900 mb-4">
        Money Manager
      </h1>
      <p class="text-xl text-gray-600 max-w-2xl mx-auto">
        Track your income and expenses by month. Add transactions, categorize them, 
        and view monthly summaries with totals and net balance.
      </p>
    </section>

    <!-- File Operations Section -->
    <section class="bg-white rounded-lg shadow-sm border border-gray-200 p-8">
      <div class="space-y-6">
        <h2 class="text-2xl font-semibold text-gray-900">Data Management</h2>
        
        <div class="flex flex-wrap gap-4">
          <button 
            id="upload-btn"
            class="inline-flex items-center space-x-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
            </svg>
            <span>Upload Data</span>
          </button>
          
          <button 
            id="download-btn"
            class="inline-flex items-center space-x-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
            </svg>
            <span>Download Data</span>
          </button>
          
          <button 
            id="load-sample-btn"
            class="inline-flex items-center space-x-2 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            <span>Load Sample Data</span>
          </button>
          
          <button 
            id="clear-btn"
            class="inline-flex items-center space-x-2 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
            <span>Clear All Data</span>
          </button>
        </div>
        
        <div class="text-sm text-gray-600">
          <p>Your data is stored locally in your browser. Use the download button to backup your data as a JSON file.</p>
          <p class="mt-1">New to Money Manager? Try the <strong>Load Sample Data</strong> button to see how it works.</p>
        </div>
      </div>
    </section>

    <!-- Monthly Dashboard Section -->
    <section class="bg-white rounded-lg shadow-sm border border-gray-200 p-8">
      <div class="space-y-6">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
          <h2 class="text-2xl font-semibold text-gray-900">Monthly Dashboard</h2>
          
          <!-- Month and Category Filters -->
          <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
            <select id="month-filter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <option value="">All Months</option>
              <!-- Month options will be populated by JavaScript -->
            </select>
            
            <select id="category-filter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <option value="">All Categories</option>
              <!-- Category options will be populated by JavaScript -->
            </select>
          </div>
        </div>
        
        <!-- Summary Cards -->
        <div id="dashboard-summary" class="grid gap-4 sm:gap-6 grid-cols-1 sm:grid-cols-2">
          <!-- Summary cards will be inserted here by JavaScript -->
          <div class="text-center text-gray-500 col-span-full py-8">
            No data available. Upload a JSON file, load sample data, or add transactions to get started.
          </div>
        </div>
        
        <!-- Charts Section -->
        <div id="dashboard-charts" class="grid gap-6 lg:grid-cols-2">
          <!-- Charts will be inserted here by JavaScript -->
        </div>
        
        <!-- Category Breakdown -->
        <div id="category-breakdown" class="space-y-6">
          <!-- Category breakdown will be inserted here by JavaScript -->
        </div>
      </div>
    </section>

    <!-- Transaction Management Section -->
    <section class="bg-white rounded-lg shadow-sm border border-gray-200 p-8">
      <div class="space-y-6">
        <div class="flex justify-between items-center">
          <h2 class="text-2xl font-semibold text-gray-900">Transactions</h2>
          <button 
            id="add-transaction-btn"
            class="inline-flex items-center space-x-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m6 0H6"/>
            </svg>
            <span>Add Transaction</span>
          </button>
        </div>
        
        <!-- Add/Edit Transaction Form (hidden by default) -->
        <div id="add-transaction-form" class="hidden bg-gray-50 rounded-lg p-6 border border-gray-200">
          <h3 id="form-title" class="text-lg font-semibold text-gray-900 mb-4">Add New Transaction</h3>
          <input type="hidden" id="editing-transaction-id" value="">
          <div class="grid gap-4 md:grid-cols-2">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Date</label>
              <input 
                type="date" 
                id="transaction-date" 
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
              <select 
                id="transaction-type" 
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              >
                <option value="income">Income</option>
                <option value="expense">Expense</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
              <div class="flex space-x-2">
                <select 
                  id="transaction-category" 
                  class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                >
                  <!-- Categories will be populated by JavaScript -->
                </select>
                <button 
                  type="button"
                  id="manage-categories-btn"
                  class="px-3 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg transition-colors"
                  title="Manage categories"
                >
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c-.94 1.543.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c.94-1.543-.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                  </svg>
                </button>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Amount</label>
              <input 
                type="number" 
                id="transaction-amount" 
                step="0.01" 
                placeholder="0.00"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              />
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
              <input 
                type="text" 
                id="transaction-description" 
                placeholder="Enter description"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              />
            </div>
          </div>
          <div class="flex space-x-3 mt-4">
            <button 
              id="save-transaction-btn"
              class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors"
            >
              <span id="save-button-text">Add Transaction</span>
            </button>
            <button 
              id="cancel-transaction-btn"
              class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-lg transition-colors"
            >
              Cancel
            </button>
          </div>
        </div>
        
        <!-- Transaction List -->
        <div id="transaction-list" class="space-y-4">
          <!-- Transactions will be inserted here by JavaScript -->
          <div class="text-center text-gray-500 py-8">
            No transactions yet. Add your first transaction to get started.
          </div>
        </div>
      </div>
    </section>

    <!-- Category Management Modal (hidden by default) -->
    <div id="category-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Manage Categories</h3>
        
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
            <select id="category-type-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <option value="income">Income</option>
              <option value="expense">Expense</option>
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Add New Category</label>
            <div class="flex space-x-2">
              <input 
                type="text" 
                id="new-category-input" 
                placeholder="Enter category name"
                class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              />
              <button 
                id="add-category-btn"
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors"
              >
                Add
              </button>
            </div>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Current Categories</label>
            <div id="current-categories-list" class="space-y-2 max-h-40 overflow-y-auto">
              <!-- Categories will be populated by JavaScript -->
            </div>
          </div>
        </div>
        
        <div class="flex justify-end space-x-3 mt-6">
          <button 
            id="close-category-modal-btn"
            class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-lg transition-colors"
          >
            Close
          </button>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<script src="../../scripts/money-manager.ts"></script>
<script is:inline>
  // Initialize money manager when the script is loaded
  let moneyManager;
  
  // Wait for MoneyManager to be available from the loaded TypeScript file
  function initializeMoneyManager() {
    if (typeof MoneyManager !== 'undefined') {
      try {
        moneyManager = new MoneyManager();
        initializeApp();
      } catch (error) {
        console.error('Error initializing MoneyManager:', error);
      }
    } else {
      // Retry after a short delay if not loaded yet
      setTimeout(initializeMoneyManager, 100);
    }
  }
  
  // Initialize the app after MoneyManager is ready
  function initializeApp() {
    // DOM elements
    const uploadBtn = document.getElementById('upload-btn');
    const downloadBtn = document.getElementById('download-btn');
    const loadSampleBtn = document.getElementById('load-sample-btn');
    const clearBtn = document.getElementById('clear-btn');
    const addTransactionBtn = document.getElementById('add-transaction-btn');
    const saveTransactionBtn = document.getElementById('save-transaction-btn');
    const cancelTransactionBtn = document.getElementById('cancel-transaction-btn');
    const addTransactionForm = document.getElementById('add-transaction-form');
    const dashboardSummaryContainer = document.getElementById('dashboard-summary');
    const dashboardChartsContainer = document.getElementById('dashboard-charts');
    const categoryBreakdownContainer = document.getElementById('category-breakdown');
    const transactionListContainer = document.getElementById('transaction-list');
    
    // Filter elements
    const monthFilter = document.getElementById('month-filter');
    const categoryFilter = document.getElementById('category-filter');

    // Category management elements
    const manageCategoriesBtn = document.getElementById('manage-categories-btn');
    const categoryModal = document.getElementById('category-modal');
    const categoryTypeSelect = document.getElementById('category-type-select');
    const newCategoryInput = document.getElementById('new-category-input');
    const addCategoryBtn = document.getElementById('add-category-btn');
    const currentCategoriesList = document.getElementById('current-categories-list');
    const closeCategoryModalBtn = document.getElementById('close-category-modal-btn');

    // Form elements
    const transactionDate = document.getElementById('transaction-date');
    const transactionType = document.getElementById('transaction-type');
    const transactionCategory = document.getElementById('transaction-category');
    const transactionAmount = document.getElementById('transaction-amount');
    const transactionDescription = document.getElementById('transaction-description');

    // Update category dropdown based on transaction type
    function updateCategories() {
      const type = transactionType?.value;
      if (!type || !moneyManager) return;

      const categories = moneyManager.getCategories(type);
      
      if (transactionCategory) {
        transactionCategory.innerHTML = '';
        categories.forEach(category => {
          const option = document.createElement('option');
          option.value = category;
          option.textContent = category;
          transactionCategory.appendChild(option);
        });
      }
    }

    // Show/hide add transaction form
    function showAddTransactionForm() {
      if (addTransactionForm) {
        addTransactionForm.classList.remove('hidden');
        
        // Set today's date as default
        if (transactionDate) {
          transactionDate.value = new Date().toISOString().split('T')[0];
        }
      }
    }

    function hideAddTransactionForm() {
      if (addTransactionForm) {
        addTransactionForm.classList.add('hidden');
        transactionDescription.value = '';
        transactionAmount.value = '';
        
        // Reset form title and button text
        const formTitle = document.getElementById('form-title');
        const saveButtonText = document.getElementById('save-button-text');
        const editingId = document.getElementById('editing-transaction-id');
        
        if (formTitle) formTitle.textContent = 'Add New Transaction';
        if (saveButtonText) saveButtonText.textContent = 'Add Transaction';
        if (editingId) editingId.value = '';
      }
    }

    // Add or update transaction
    function handleAddTransaction() {
      if (!moneyManager) return;
      
      const editingId = document.getElementById('editing-transaction-id')?.value;
      const date = transactionDate?.value;
      const type = transactionType?.value;
      const category = transactionCategory?.value;
      const amount = parseFloat(transactionAmount?.value || '0');
      const description = transactionDescription?.value;

      if (!date || !amount || !description) {
        alert('Please fill in all fields');
        return;
      }

      if (amount <= 0) {
        alert('Amount must be greater than 0');
        return;
      }

      if (new Date(date) > new Date()) {
        alert('Date cannot be in the future');
        return;
      }

      const transaction = {
        id: editingId || Date.now().toString(),
        date,
        description,
        amount: type === 'expense' ? -Math.abs(amount) : Math.abs(amount),
        category,
        type
      };

      try {
        if (editingId) {
          // Update existing transaction
          const data = moneyManager.getData();
          const index = data.transactions.findIndex(t => t.id === editingId);
          if (index !== -1) {
            data.transactions[index] = transaction;
            moneyManager.setData(data);
          }
        } else {
          // Add new transaction
          moneyManager.addTransaction(transaction);
        }
        
        renderDashboard();
        renderTransactions();
        hideAddTransactionForm();
      } catch (error) {
        alert(`Error saving transaction: ${error.message}`);
      }
    }

    // Edit transaction
    function editTransaction(id) {
      if (!moneyManager) return;
      
      const data = moneyManager.getData();
      const transaction = data.transactions.find(t => t.id === id);
      
      if (!transaction) return;
      
      // Populate form with transaction data
      const formTitle = document.getElementById('form-title');
      const saveButtonText = document.getElementById('save-button-text');
      const editingId = document.getElementById('editing-transaction-id');
      const dateInput = document.getElementById('transaction-date');
      const typeInput = document.getElementById('transaction-type');
      const categoryInput = document.getElementById('transaction-category');
      const amountInput = document.getElementById('transaction-amount');
      const descriptionInput = document.getElementById('transaction-description');
      
      if (formTitle) formTitle.textContent = 'Edit Transaction';
      if (saveButtonText) saveButtonText.textContent = 'Update Transaction';
      if (editingId) editingId.value = id;
      if (dateInput) dateInput.value = transaction.date;
      if (typeInput) typeInput.value = transaction.type;
      if (descriptionInput) descriptionInput.value = transaction.description;
      if (amountInput) amountInput.value = Math.abs(transaction.amount).toString();
      
      // Update categories and set the correct category
      updateCategories();
      setTimeout(() => {
        if (categoryInput) categoryInput.value = transaction.category;
      }, 100);
      
      // Show the form
      showAddTransactionForm();
    }

    // Delete transaction
    function deleteTransaction(id) {
      if (!moneyManager) return;
      
      if (confirm('Are you sure you want to delete this transaction?')) {
        moneyManager.deleteTransaction(id);
        renderDashboard();
        renderTransactions();
      }
    }

    // Get filtered transactions based on selected filters
    function getFilteredTransactions() {
      if (!moneyManager) return [];
      
      const monthFilter = document.getElementById('month-filter')?.value;
      const categoryFilter = document.getElementById('category-filter')?.value;
      
      return moneyManager.getFilteredTransactions(monthFilter, categoryFilter);
    }
    
    // Calculate summary from filtered transactions
    function calculateSummaryFromTransactions(transactions) {
      if (!moneyManager) return {
        income: 0,
        expenses: 0,
        net: 0,
        transactionCount: 0,
        categoryData: {}
      };
      
      return moneyManager.calculateSummaryFromTransactions(transactions);
    }
    
    // Update filter options
    function updateFilterOptions() {
      if (!moneyManager) return;
      
      // Update month filter
      if (monthFilter) {
        const months = moneyManager.getAvailableMonths();
        const currentValue = monthFilter.value;
        
        monthFilter.innerHTML = '<option value="">All Months</option>' + 
          months.map(month => `
            <option value="${month}">${formatMonth(month)}</option>
          `).join('');
        
        // Restore previous selection if it still exists
        if (currentValue && months.includes(currentValue)) {
          monthFilter.value = currentValue;
        }
      }
      
      // Update category filter
      if (categoryFilter) {
        const allCategories = moneyManager.getAllCategories();
        const currentValue = categoryFilter.value;
        
        categoryFilter.innerHTML = '<option value="">All Categories</option>' + 
          allCategories.map(category => `
            <option value="${category}">${category}</option>
          `).join('');
        
        // Restore previous selection if it still exists
        if (currentValue && allCategories.includes(currentValue)) {
          categoryFilter.value = currentValue;
        }
      }
    }
    
    // Render dashboard summary cards
    function renderDashboardSummary() {
      if (!dashboardSummaryContainer || !moneyManager) return;
      
      const transactions = getFilteredTransactions();
      const summary = calculateSummaryFromTransactions(transactions);
      
      if (transactions.length === 0) {
        dashboardSummaryContainer.innerHTML = `
          <div class="text-center text-gray-500 col-span-full py-8">
            No data available. Upload a JSON file, load sample data, or add transactions to get started.
          </div>
        `;
        return;
      }
      
      dashboardSummaryContainer.innerHTML = `
        <div class="bg-green-50 rounded-lg p-4 sm:p-6 border border-green-200">
          <div class="flex items-center justify-between">
            <div class="flex-1">
              <p class="text-sm font-medium text-green-600">Total Income</p>
              <p class="text-lg sm:text-2xl font-bold text-green-700">฿${summary.income.toFixed(2)}</p>
            </div>
            <div class="bg-green-100 rounded-full p-2 sm:p-3 flex-shrink-0 ml-2 sm:ml-4">
              <svg class="w-5 h-5 sm:w-6 sm:h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
              </svg>
            </div>
          </div>
        </div>
        
        <div class="bg-red-50 rounded-lg p-4 sm:p-6 border border-red-200">
          <div class="flex items-center justify-between">
            <div class="flex-1">
              <p class="text-sm font-medium text-red-600">Total Expenses</p>
              <p class="text-lg sm:text-2xl font-bold text-red-700">฿${summary.expenses.toFixed(2)}</p>
            </div>
            <div class="bg-red-100 rounded-full p-2 sm:p-3 flex-shrink-0 ml-2 sm:ml-4">
              <svg class="w-5 h-5 sm:w-6 sm:h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/>
              </svg>
            </div>
          </div>
        </div>
        
        <div class="${summary.net >= 0 ? 'bg-blue-50 border-blue-200' : 'bg-orange-50 border-orange-200'} rounded-lg p-4 sm:p-6 border">
          <div class="flex items-center justify-between">
            <div class="flex-1">
              <p class="text-sm font-medium ${summary.net >= 0 ? 'text-blue-600' : 'text-orange-600'}">Net Balance</p>
              <p class="text-lg sm:text-2xl font-bold ${summary.net >= 0 ? 'text-blue-700' : 'text-orange-700'}">฿${summary.net.toFixed(2)}</p>
            </div>
            <div class="${summary.net >= 0 ? 'bg-blue-100' : 'bg-orange-100'} rounded-full p-2 sm:p-3 flex-shrink-0 ml-2 sm:ml-4">
              <svg class="w-5 h-5 sm:w-6 sm:h-6 ${summary.net >= 0 ? 'text-blue-600' : 'text-orange-600'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
              </svg>
            </div>
          </div>
        </div>
        
        <div class="bg-purple-50 rounded-lg p-4 sm:p-6 border border-purple-200">
          <div class="flex items-center justify-between">
            <div class="flex-1">
              <p class="text-sm font-medium text-purple-600">Transactions</p>
              <p class="text-lg sm:text-2xl font-bold text-purple-700">${summary.transactionCount}</p>
            </div>
            <div class="bg-purple-100 rounded-full p-2 sm:p-3 flex-shrink-0 ml-2 sm:ml-4">
              <svg class="w-5 h-5 sm:w-6 sm:h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
              </svg>
            </div>
          </div>
        </div>
      `;
    }
    
    // Render charts
    function renderCharts() {
      if (!dashboardChartsContainer || !moneyManager) return;
      
      const transactions = getFilteredTransactions();
      const summary = calculateSummaryFromTransactions(transactions);
      
      if (transactions.length === 0) {
        dashboardChartsContainer.innerHTML = '';
        return;
      }
      
      // Income vs Expenses Bar Chart
      const maxAmount = Math.max(summary.income, summary.expenses);
      const incomeWidth = maxAmount > 0 ? (summary.income / maxAmount) * 100 : 0;
      const expensesWidth = maxAmount > 0 ? (summary.expenses / maxAmount) * 100 : 0;
      
      // Category breakdown data
      const incomeCategories = summary.categoryData.income || {};
      const expenseCategories = summary.categoryData.expense || {};
      
      const incomeTotal = Object.values(incomeCategories).reduce((sum, amount) => sum + amount, 0);
      const expenseTotal = Object.values(expenseCategories).reduce((sum, amount) => sum + amount, 0);
      
      dashboardChartsContainer.innerHTML = `
        <!-- Income vs Expenses Chart -->
        <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Income vs Expenses</h3>
          <div class="space-y-4">
            <div>
              <div class="flex justify-between mb-1">
                <span class="text-sm font-medium text-green-600">Income</span>
                <span class="text-sm text-gray-600">฿${summary.income.toFixed(2)}</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-8">
                <div class="bg-green-500 h-8 rounded-full flex items-center justify-center text-white text-sm font-medium" style="width: ${incomeWidth}%">
                  ${incomeWidth > 10 ? `${incomeWidth.toFixed(1)}%` : ''}
                </div>
              </div>
            </div>
            
            <div>
              <div class="flex justify-between mb-1">
                <span class="text-sm font-medium text-red-600">Expenses</span>
                <span class="text-sm text-gray-600">฿${summary.expenses.toFixed(2)}</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-8">
                <div class="bg-red-500 h-8 rounded-full flex items-center justify-center text-white text-sm font-medium" style="width: ${expensesWidth}%">
                  ${expensesWidth > 10 ? `${expensesWidth.toFixed(1)}%` : ''}
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Category Distribution -->
        <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Category Distribution</h3>
          <div class="space-y-6">
            <!-- Income Categories -->
            ${incomeTotal > 0 ? `
              <div>
                <h4 class="text-sm font-medium text-green-600 mb-3">Income Categories</h4>
                <div class="space-y-2">
                  ${Object.entries(incomeCategories)
                    .sort(([,a], [,b]) => b - a)
                    .map(([category, amount]) => {
                      const percentage = (amount / incomeTotal) * 100;
                      return `
                        <div>
                          <div class="flex justify-between mb-1">
                            <span class="text-sm text-gray-700">${category}</span>
                            <span class="text-sm text-gray-600">฿${amount.toFixed(2)} (${percentage.toFixed(1)}%)</span>
                          </div>
                          <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-green-500 h-2 rounded-full" style="width: ${percentage}%"></div>
                          </div>
                        </div>
                      `;
                    }).join('')}
                </div>
              </div>
            ` : ''}
            
            <!-- Expense Categories -->
            ${expenseTotal > 0 ? `
              <div>
                <h4 class="text-sm font-medium text-red-600 mb-3">Expense Categories</h4>
                <div class="space-y-2">
                  ${Object.entries(expenseCategories)
                    .sort(([,a], [,b]) => b - a)
                    .map(([category, amount]) => {
                      const percentage = (amount / expenseTotal) * 100;
                      return `
                        <div>
                          <div class="flex justify-between mb-1">
                            <span class="text-sm text-gray-700">${category}</span>
                            <span class="text-sm text-gray-600">฿${amount.toFixed(2)} (${percentage.toFixed(1)}%)</span>
                          </div>
                          <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-red-500 h-2 rounded-full" style="width: ${percentage}%"></div>
                          </div>
                        </div>
                      `;
                    }).join('')}
                </div>
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }
    
    // Render category breakdown table
    function renderCategoryBreakdown() {
      if (!categoryBreakdownContainer || !moneyManager) return;
      
      const transactions = getFilteredTransactions();
      const summary = calculateSummaryFromTransactions(transactions);
      
      if (transactions.length === 0) {
        categoryBreakdownContainer.innerHTML = '';
        return;
      }
      
      const incomeCategories = summary.categoryData.income || {};
      const expenseCategories = summary.categoryData.expense || {};
      
      categoryBreakdownContainer.innerHTML = `
        <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Category Breakdown</h3>
          
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-100">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                  <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                  <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Transactions</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                ${Object.entries(incomeCategories).map(([category, amount]) => {
                  const count = transactions.filter(t => t.type === 'income' && t.category === category).length;
                  return `
                    <tr>
                      <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${category}</td>
                      <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                          Income
                        </span>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right">฿${amount.toFixed(2)}</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right">${count}</td>
                    </tr>
                  `;
                }).join('')}
                
                ${Object.entries(expenseCategories).map(([category, amount]) => {
                  const count = transactions.filter(t => t.type === 'expense' && t.category === category).length;
                  return `
                    <tr>
                      <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${category}</td>
                      <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">
                          Expense
                        </span>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right">฿${amount.toFixed(2)}</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right">${count}</td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }
    
    // Main dashboard render function
    function renderDashboard() {
      updateFilterOptions();
      renderDashboardSummary();
      renderCharts();
      renderCategoryBreakdown();
    }

    // Render transactions
    function renderTransactions() {
      if (!transactionListContainer || !moneyManager) return;

      const transactions = getFilteredTransactions();
      
      if (transactions.length === 0) {
        // Check if there are any transactions at all
        const allTransactions = moneyManager.getData().transactions;
        if (allTransactions.length === 0) {
          transactionListContainer.innerHTML = `
            <div class="text-center text-gray-500 py-8">
              No transactions yet. Add your first transaction to get started.
            </div>
          `;
        } else {
          transactionListContainer.innerHTML = `
            <div class="text-center text-gray-500 py-8">
              No transactions match the current filters. Try adjusting the month or category filters.
            </div>
          `;
        }
        return;
      }
      
      // Sort transactions by date (newest first)
      const sortedTransactions = [...transactions].sort((a, b) => 
        b.date.localeCompare(a.date)
      );
      
      transactionListContainer.innerHTML = sortedTransactions.map(transaction => `
        <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
          <div class="flex justify-between items-start">
            <div class="flex-1">
              <div class="flex items-center space-x-3">
                <span class="text-sm text-gray-500">${formatDate(transaction.date)}</span>
                <span class="inline-block px-2 py-1 text-xs rounded-full ${
                  transaction.type === 'income' 
                    ? 'bg-green-100 text-green-700' 
                    : 'bg-red-100 text-red-700'
                }">
                  ${transaction.type}
                </span>
                <span class="inline-block px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded-full">
                  ${transaction.category}
                </span>
              </div>
              <h4 class="font-medium text-gray-900 mt-2">${transaction.description}</h4>
            </div>
            <div class="flex items-center space-x-3">
              <span class="text-lg font-semibold ${
                transaction.type === 'income' ? 'text-green-600' : 'text-red-600'
              }">
                ${transaction.type === 'income' ? '+' : '-'}฿${Math.abs(transaction.amount).toFixed(2)}
              </span>
              <div class="flex space-x-2">
                <button 
                  onclick="editTransaction('${transaction.id}')"
                  class="text-blue-600 hover:text-blue-800 transition-colors"
                  title="Edit transaction"
                >
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                  </svg>
                </button>
                <button 
                  onclick="deleteTransaction('${transaction.id}')"
                  class="text-red-600 hover:text-red-800 transition-colors"
                  title="Delete transaction"
                >
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>
      `).join('');
    }

    // File operations
    function handleUpload() {
      if (!moneyManager) return;
      
      handleFileUpload((data) => {
        try {
          moneyManager.setData(data);
          renderDashboard();
          renderTransactions();
          alert('Data uploaded successfully!');
        } catch (error) {
          alert(`Error uploading data: ${error.message}`);
        }
      });
    }

    function handleDownload() {
      if (!moneyManager) return;
      
      downloadData(moneyManager.getData());
    }

    function handleLoadSample() {
      if (!moneyManager) return;
      
      if (confirm('This will replace your current data with sample transactions. Continue?')) {
        try {
          loadSampleData((data) => {
            moneyManager.setData(data);
            renderDashboard();
            renderTransactions();
            alert('Sample data loaded successfully!');
          });
        } catch (error) {
          alert(`Error loading sample data: ${error.message}`);
        }
      }
    }

    function handleClear() {
      if (!moneyManager) return;
      
      if (confirm('Are you sure you want to clear all data? This action cannot be undone.')) {
        moneyManager.clearAllData();
        renderDashboard();
        renderTransactions();
      }
    }

    // Category management functions
    function showCategoryModal() {
      if (categoryModal) {
        categoryModal.classList.remove('hidden');
        updateCategoriesList();
      }
    }

    function hideCategoryModal() {
      if (categoryModal) {
        categoryModal.classList.add('hidden');
      }
    }

    function updateCategoriesList() {
      if (!currentCategoriesList || !moneyManager) return;
      
      const type = categoryTypeSelect?.value || 'income';
      const categories = moneyManager.getCategories(type);
      
      currentCategoriesList.innerHTML = categories.map(category => `
        <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
          <span class="text-sm">${category}</span>
          <button 
            onclick="removeCategory('${type}', '${category}')"
            class="text-red-600 hover:text-red-800 text-sm"
          >
            Remove
          </button>
        </div>
      `).join('');
    }

    function addNewCategory() {
      if (!moneyManager) return;
      
      const type = categoryTypeSelect?.value;
      const categoryName = newCategoryInput?.value?.trim();
      
      if (!type || !categoryName) {
        alert('Please select a type and enter a category name');
        return;
      }
      
      try {
        const data = moneyManager.getData();
        if (!data.categories[type].includes(categoryName)) {
          data.categories[type].push(categoryName);
          data.categories[type].sort(); // Sort alphabetically
          moneyManager.setData(data);
          
          if (newCategoryInput) newCategoryInput.value = '';
          updateCategoriesList();
          updateCategories(); // Update the transaction form categories
          renderDashboard(); // Refresh dashboard to show new categories
        } else {
          alert('This category already exists');
        }
      } catch (error) {
        alert(`Error adding category: ${error.message}`);
      }
    }

    function removeCategory(type, category) {
      if (!moneyManager) return;
      
      if (confirm(`Remove "${category}" from ${type} categories?`)) {
        try {
          const data = moneyManager.getData();
          data.categories[type] = data.categories[type].filter(c => c !== category);
          moneyManager.setData(data);
          updateCategoriesList();
          updateCategories(); // Update the transaction form categories
          renderDashboard(); // Refresh dashboard to show category changes
        } catch (error) {
          alert(`Error removing category: ${error.message}`);
        }
      }
    }

    // Attach event listeners
    function attachEventListeners() {
      if (uploadBtn) uploadBtn.addEventListener('click', handleUpload);
      if (downloadBtn) downloadBtn.addEventListener('click', handleDownload);
      if (loadSampleBtn) loadSampleBtn.addEventListener('click', handleLoadSample);
      if (clearBtn) clearBtn.addEventListener('click', handleClear);
      if (addTransactionBtn) addTransactionBtn.addEventListener('click', showAddTransactionForm);
      if (saveTransactionBtn) saveTransactionBtn.addEventListener('click', handleAddTransaction);
      if (cancelTransactionBtn) cancelTransactionBtn.addEventListener('click', hideAddTransactionForm);
      
      if (transactionType) {
        transactionType.addEventListener('change', updateCategories);
      }
      
      // Filter event listeners
      if (monthFilter) monthFilter.addEventListener('change', () => {
        renderDashboard();
        renderTransactions();
      });
      
      if (categoryFilter) categoryFilter.addEventListener('change', () => {
        renderDashboard();
        renderTransactions();
      });
      
      // Category management event listeners
      if (manageCategoriesBtn) manageCategoriesBtn.addEventListener('click', showCategoryModal);
      if (closeCategoryModalBtn) closeCategoryModalBtn.addEventListener('click', hideCategoryModal);
      if (addCategoryBtn) addCategoryBtn.addEventListener('click', addNewCategory);
      if (categoryTypeSelect) categoryTypeSelect.addEventListener('change', updateCategoriesList);
      
      // Close modal when clicking outside
      if (categoryModal) {
        categoryModal.addEventListener('click', (e) => {
          if (e.target === categoryModal) {
            hideCategoryModal();
          }
        });
      }
    }

    // Make deleteTransaction, editTransaction, and removeCategory globally available for inline onclick handlers
    window.deleteTransaction = deleteTransaction;
    window.editTransaction = editTransaction;
    window.removeCategory = removeCategory;

    // Initialize the app
    updateCategories();
    renderDashboard();
    renderTransactions();
    attachEventListeners();
  }

  // Start initialization when DOM is ready
  document.addEventListener('DOMContentLoaded', initializeMoneyManager);
</script>
